function ChatHtml() { var container = document.createDocumentFragment(); var e_0 = document.createElement("div"); var e_1 = document.createElement("style"); e_1.appendChild(document.createTextNode(`.chatbox{width:320px;height:400px;border:2px solid#ccc;background-color:#f9f9f9;position:fixed;bottom:50px;right:50px;box-shadow:0 0 10px rgba(0,0,0,0.2);z-index:1000}.chatbox-header{box-shadow:0 2px 3px rgba(0,0,0,0.1);background:rgba(255,255,255,0.2);backdrop-filter:blur(2.5px);padding:10px;user-select:none}.chatbox-body{max-height:88%;overflow-y:scroll;overflow-x:hidden;padding:10px;height:calc(100%-40px)}.chatbox-body.message-content{padding:0.75rem 1rem;margin:10px;border-radius:0.75rem;word-wrap:break-word;background-color:#f1f1f1}.chatbox img{max-height:100%;max-width:100%}.chatbox-footer{padding:10px;position:absolute;width:100%;bottom:0}.chatbox-footer input[type="text"]{width:80%;padding:8px;border:1px solid#ccc;border-radius:4px}.chatbox.collapsed.chatbox-body,.chatbox.collapsed.chatbox-footer{display:none}.chatbox.collapsed{height:40px}.chatbox-body,.chatbox-footer{height:auto;opacity:1}#toggleChatbox,#scrollToBottom{float:right;background-color:transparent;border:none;cursor:pointer;font-size:16px;transition:transform 0.2s}@media(max-width:600px){.chatbox{width:100%;right:0;bottom:0}}`)); e_0.appendChild(e_1); var e_2 = document.createElement("div"); e_2.setAttribute("class", "chatbox collapsed"); e_2.setAttribute("id", "chatbox"); var e_3 = document.createElement("div"); e_3.setAttribute("class", "chatbox-header"); e_3.setAttribute("id", "chatboxHeader"); e_3.appendChild(document.createTextNode("\n简易聊天室\n")); var e_4 = document.createElement("a"); e_4.setAttribute("href", "https://chat.zicheng.icu/"); e_4.setAttribute("target", "_blank"); e_4.setAttribute("rel", "noopener noreferrer"); e_4.appendChild(document.createTextNode("完整体验地址")); e_3.appendChild(e_4); var e_5 = document.createElement("button"); e_5.setAttribute("id", "scrollToBottom"); e_5.setAttribute("onclick", "scrollToBottom()"); e_5.appendChild(document.createTextNode("返回底部")); e_3.appendChild(e_5); var e_6 = document.createElement("button"); e_6.setAttribute("id", "toggleChatbox"); e_6.appendChild(document.createTextNode("折叠")); e_3.appendChild(e_6); e_2.appendChild(e_3); var e_7 = document.createElement("div"); e_7.setAttribute("class", "chatbox-body"); e_2.appendChild(e_7); e_0.appendChild(e_2); container.appendChild(e_0); return container } const apiUrl = 'https://chat.zicheng.icu'; const chatbox = $("#chatbox"), chatboxBody = $(".chatbox-body"), chatboxFooter = $(".chatbox-footer"); let offset = 0, isCollapsed = false, firstLoad = true; $("#toggleChatbox").click(toggleChatbox); $(".chatbox-footer input").keypress(e => { if (e.which == 13) sendMessage($(e.target).val()) }); function toggleChatbox() { chatbox.toggleClass("collapsed"); isCollapsed = !isCollapsed; if (!isCollapsed) { chatboxBody.css("height", ""); chatboxFooter.css("height", "") } } function sendMessage(message) { if (message.trim()) { $.post(`${apiUrl}/api/chat`, { message }, response => { handleSendMessageResponse(response, message) }).fail(() => appendMessage("消息发送失败", "end")) } } function handleSendMessageResponse(response, message) { appendMessage(response.status === "success" ? `${message}` : "消息发送失败", "end"); resetInputField() } function appendMessage(content, alignment) { chatboxBody.append(`<div class="message-content"style="text-align:${alignment};">${content}</div>`); scrollToBottom() } function resetInputField() { $(".chatbox-footer input").val("") } function scrollToBottom() { chatboxBody.scrollTop(chatboxBody[0].scrollHeight) } function loadMessages() { $.get(`${apiUrl}/api/chat`, { offset }, data => { populateMessages(data.messages) }).fail(() => appendMessage("无法加载聊天记录", "center")) } function populateMessages(messages) { if (messages.length > 0) { offset += messages.length; let lastFetched = messages[messages.length - 1].created_at; messages.forEach(function (message) { let alignment = message.type === "user" ? "left" : "right"; let userDisplayName = message.type === "user" ? message.user_name : "系统"; appendMessage(`${userDisplayName}:${message.content}`, alignment) }); if (firstLoad) { scrollToBottom(); firstLoad = false } } } window.onload = function () { document.body.appendChild(ChatHtml()); loadMessages(); setInterval(loadMessages, 3000) };